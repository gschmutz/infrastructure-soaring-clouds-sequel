version: '2'

services:
  zookeeper-1:
    image: 'confluentinc/cp-zookeeper:5.1.0'
    container_name: zookeeper-1
    ports:
      - '2181:2181/tcp'
    environment:
      - ZOOKEEPER_CLIENT_PORT=2181
      - ZOOKEEPER_TICK_TIME=2000

  broker-1:
    image: 'confluentinc/cp-enterprise-kafka:5.1.0'
    container_name: broker-1
    ports:
      - '9092:9092/tcp'
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_BROKER_RACK=rack-a
      - 'KAFKA_ZOOKEEPER_CONNECT=zookeeper-1:2181'
      - KAFKA_ADVERTISED_HOST_NAME=129.156.113.127
      - 'KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://broker-1:9092'
      - >-
        KAFKA_METRIC_REPORTERS=io.confluent.metrics.reporter.ConfluentMetricsReporter
      - KAFKA_DELETE_TOPIC_ENABLE=true
      - KAFKA_JMX_PORT=9999
      - >-
        KAFKA_JMX_OPTS=-Dcom.sun.management.jmxremote
        -Dcom.sun.management.jmxremote.authenticate=false
        -Dcom.sun.management.jmxremote.ssl=false
        -Dcom.sun.management.jmxremote.local.only=false
        -Dcom.sun.management.jmxremote.rmi.port=9999
      - KAFKA_JMX_HOSTNAME=broker-1
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - 'CONFLUENT_METRICS_REPORTER_BOOTSTRAP_SERVERS=broker-1:9092'
      - 'CONFLUENT_METRICS_REPORTER_ZOOKEEPER_CONNECT=zookeeper-1:2181'
      - CONFLUENT_METRICS_REPORTER_TOPIC_REPLICAS=1
      - CONFLUENT_METRICS_ENABLE=true
      - CONFLUENT_SUPPORT_CUSTOMER_ID=anonymous

  schema-registry:
    image: 'confluentinc/cp-schema-registry:5.1.0'
    container_name: schema-registry
    ports:
      - '8081:8081/tcp'
    environment:
      - SCHEMA_REGISTRY_HOST_NAME=schema_registry
      - 'SCHEMA_REGISTRY_KAFKASTORE_CONNECTION_URL=zookeeper-1:2181'
      - SCHEMA_REGISTRY_ACCESS_CONTROL_ALLOW_ORIGIN=*
      - 'SCHEMA_REGISTRY_ACCESS_CONTROL_ALLOW_METHODS=GET,POST,PUT,OPTIONS'

  kafka-manager:
    image: trivadisbds/kafka-manager
    container_name: kafka-manager
    links:
      - broker-1
    ports:
      - '9000:9000/tcp'
    environment:
      - 'ZK_HOSTS=129.156.113.127:2181'
      - APPLICATION_SECRET=letmein
      
  schema-registry-ui:
    image: landoop/schema-registry-ui
    container_name: schema-registry-ui
    ports:
      - '8002:8000/tcp'
    environment:
      - 'SCHEMAREGISTRY_URL=http://${PUBLIC_IP}:8081'

  mongo-prod:
    image: mongo:latest
    container_name: mongo-prod
    ports:
      - 27017:27017
    #environment:
    #  - MONGODB_USER=debezium
    #  - MONGODB_PASSWORD=dbz

  product:
    image: gschmutz/product-soaring-clouds-sequel
    container_name: product
    environment:
      - KAFKA_BOOTSTRAP-SERVERS=129.150.77.116:6667
      - SPRING_KAFKA_SCHEMA-REGISTRY-URL=http://${DOCKER_HOST_IP}:8081
      - SPRING_DATA_MONGODB_ADDRESS=mongo-prod
      - KAFKA_TOPIC_ADDTOSHOPPINGCART=a516817-soaring-add-to-shopping-cart
      - KAFKA_TOPIC_PRODUCT=a516817-soaring-products
    ports:
      - 8080:8080

